---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import ExerciseQuiz from '../../../components/ExerciseQuiz.astro';
import {
  formatHSKLevelLabel,
  formatInlineGrammarText,
  getGrammarPoints,
  getGroupsForPoint,
  toPlainGrammarText,
  type GrammarPoint,
} from '../../../data/grammarCatalog';
import { getHSKLevelInfo } from '../../../types/hsk';
import { buildGrammarPointExercises } from '../../../utils/exercises';

export async function getStaticPaths() {
  return getGrammarPoints().map((point) => ({
    params: { id: point.id },
    props: { point },
  }));
}

const { point } = Astro.props as { point: GrammarPoint };
const levelInfo = getHSKLevelInfo(point.level);
const allPoints = getGrammarPoints();
const pointGroups = getGroupsForPoint(point.id);
const relatedPoints = allPoints
  .filter((candidate) => candidate.id !== point.id)
  .filter((candidate) => candidate.category === point.category || candidate.level === point.level)
  .slice(0, 8);

function splitCompactListItems(items: string[]): string[] {
  return items.flatMap((item) => {
    const text = item.trim();
    if (!text) return [];
    if (text.startsWith('**')) return [text];

    const sentenceChunks = text
      .split(/(?<=[.!?])\s+(?=[A-ZÀ-ÖØ-Ý]|Avec\b|Sans\b|Pour\b|Quand\b|Si\b|En\b|Au\b|À\b)/)
      .flatMap((chunk) => chunk.split(/\s*;\s+/))
      .map((chunk) => chunk.trim())
      .filter(Boolean);

    return sentenceChunks.length > 1 ? sentenceChunks : [text];
  });
}

const noteItems = splitCompactListItems(point.notes);
const mistakeItems = splitCompactListItems(point.commonMistakes);
const exerciseQuestions = buildGrammarPointExercises({
  title: point.title,
  elements: point.elements,
  examples: point.examples,
  usage: point.usage,
});

const pageSections: Array<{ id: string; label: string }> = [];
if (point.structure) pageSections.push({ id: 'structure', label: 'Structure' });
if (point.elements.length > 0) pageSections.push({ id: 'elements-concernes', label: 'Éléments concernés' });
if (point.usage.length > 0) pageSections.push({ id: 'utilisation', label: "Comment l'utiliser" });
if (point.examples.length > 0) pageSections.push({ id: 'exemples', label: 'Exemples' });
if (noteItems.length > 0) pageSections.push({ id: 'notes-exceptions', label: 'Notes et exceptions' });
if (mistakeItems.length > 0) pageSections.push({ id: 'erreurs-frequentes', label: 'Erreurs fréquentes' });
if (exerciseQuestions.length > 0) pageSections.push({ id: 'exercice-application', label: "Exercice d'application" });
---

<BaseLayout
  title={`${point.title} - Grammaire`}
  description={toPlainGrammarText(point.objective || point.structure).replace(/\*/g, '')}
>
  <section class="page-header" style={`--level-bg: ${levelInfo?.bgColor || 'var(--bg-secondary)'}`}>
    <div class="container">
      <Breadcrumb items={[
        { label: 'Grammaire', href: '/grammaire' },
        { label: formatHSKLevelLabel(point.levelLabel), href: '/grammaire' },
        { label: point.title },
      ]} />
    </div>
  </section>

  <section class="section">
    <div class="container article-layout">
      <article class="article-main">
        <header class="article-header">
          <div class="meta-row">
            <span class={`badge badge-hsk${point.level}`}>{formatHSKLevelLabel(point.levelLabel)}</span>
            <span class="meta-tag">{point.category}</span>
            {point.subcategory && <span class="meta-tag">{point.subcategory}</span>}
            {point.detail && <span class="meta-tag">{point.detail}</span>}
          </div>
          <h1>{point.title}</h1>
          {point.sourceTitle !== point.title && <p class="source-title">{point.sourceTitle}</p>}
          {point.objective && <p class="summary" set:html={formatInlineGrammarText(point.objective)}></p>}
        </header>

        {point.structure && (
          <section id="structure" class="block">
            <h2>Structure</h2>
            <pre>{point.structure}</pre>
          </section>
        )}

        {point.elements.length > 0 && (
          <section id="elements-concernes" class="block">
            <h2>Éléments concernés</h2>
            <div class="element-pills">
              {point.elements.map((element) => (
                <span>{element}</span>
              ))}
            </div>
          </section>
        )}

        {point.usage.length > 0 && (
          <section id="utilisation" class="block">
            <h2>Comment l'utiliser</h2>
            <ul>
              {point.usage.map((item) => (
                <li set:html={formatInlineGrammarText(item)}></li>
              ))}
            </ul>
          </section>
        )}

        {point.examples.length > 0 && (
          <section id="exemples" class="block">
            <h2>Exemples</h2>
            <div class="example-grid">
              {point.examples.map((example) => (
                <article class="example-card">
                  <p class="cn">{example.chinese}</p>
                  {example.pinyin && <p class="py">{example.pinyin}</p>}
                  <p class="fr">{example.french}</p>
                </article>
              ))}
            </div>
          </section>
        )}

        {noteItems.length > 0 && (
          <section id="notes-exceptions" class="block">
            <h2>Notes et exceptions</h2>
            <ul>
              {noteItems.map((note) => (
                <li set:html={formatInlineGrammarText(note)}></li>
              ))}
            </ul>
          </section>
        )}

        {mistakeItems.length > 0 && (
          <section id="erreurs-frequentes" class="block warning-block">
            <h2>Erreurs fréquentes</h2>
            <ul>
              {mistakeItems.map((mistake) => (
                <li set:html={formatInlineGrammarText(mistake)}></li>
              ))}
            </ul>
          </section>
        )}

        {exerciseQuestions.length > 0 && (
          <section id="exercice-application" class="block">
            <ExerciseQuiz
              title="Exercice d'application"
              intro="Choisis le bon élément dans chaque phrase, puis termine l'exercice pour afficher la correction."
              questions={exerciseQuestions}
              quizId={`grammar-${point.id}`}
            />
          </section>
        )}
      </article>

      <aside class="article-sidebar">
        {pageSections.length > 0 && (
          <div class="sidebar-card">
            <h3>Sommaire</h3>
            <ul class="summary-list">
              {pageSections.map((section) => (
                <li>
                  <a href={`#${section.id}`}>{section.label}</a>
                </li>
              ))}
            </ul>
          </div>
        )}

        <div class="sidebar-card">
          <h3>Niveau</h3>
          <p class="level-name">{formatHSKLevelLabel(point.levelLabel)}</p>
          {levelInfo?.description && <p class="small">{levelInfo.description}</p>}
        </div>

        {pointGroups.length > 0 && (
          <div class="sidebar-card">
            <h3>Regroupements</h3>
            <ul class="link-list">
              {pointGroups.map((group) => (
                <li>
                  <a href={`/grammaire/groupes/${group.slug}`}>{group.title}</a>
                </li>
              ))}
            </ul>
          </div>
        )}

        {relatedPoints.length > 0 && (
          <div class="sidebar-card">
            <h3>Points proches</h3>
            <ul class="link-list">
              {relatedPoints.map((candidate) => (
                <li>
                  <a href={`/grammaire/points/${candidate.id}`}>{candidate.title}</a>
                </li>
              ))}
            </ul>
          </div>
        )}

        <div class="sidebar-card">
          <a href="/grammaire" class="btn btn-secondary btn-sm">Retour au catalogue</a>
        </div>
      </aside>
    </div>
  </section>
</BaseLayout>

<style>
  .page-header {
    background: linear-gradient(135deg, var(--level-bg), var(--bg-secondary));
    padding: var(--spacing-lg) 0;
    border-bottom: 1px solid var(--border-light);
  }

  .article-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 280px;
    gap: var(--spacing-xl);
    align-items: start;
  }

  .article-main {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
  }

  .article-header {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-light);
  }

  .meta-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
  }

  .meta-tag {
    padding: 2px 10px;
    border-radius: var(--radius-full);
    background: var(--bg-secondary);
    color: var(--text-tertiary);
    font-size: 0.8rem;
  }

  .article-header h1 {
    margin-bottom: var(--spacing-sm);
  }

  .source-title {
    font-size: 0.95rem;
    color: var(--text-tertiary);
    margin-bottom: var(--spacing-xs);
  }

  .summary {
    font-size: 1.05rem;
    color: var(--text-secondary);
  }

  .block + .block {
    margin-top: var(--spacing-lg);
  }

  .block h2 {
    font-size: 1.05rem;
    margin-bottom: var(--spacing-sm);
  }

  .block {
    scroll-margin-top: 90px;
  }

  .block pre {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 0.95rem;
  }

  .block ul {
    padding-left: 1.2rem;
    color: var(--text-secondary);
    display: grid;
    gap: var(--spacing-xs);
  }

  .example-grid {
    display: grid;
    gap: var(--spacing-sm);
  }

  .element-pills {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
  }

  .element-pills span {
    padding: 4px 10px;
    border-radius: var(--radius-full);
    border: 1px solid var(--border-light);
    background: var(--bg-secondary);
    font-size: 0.86rem;
    color: var(--text-secondary);
  }

  .example-card {
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    background: var(--bg-secondary);
  }

  .example-card .cn {
    font-size: 1.1rem;
    color: var(--text-primary);
    margin-bottom: 2px;
  }

  .example-card .py {
    font-size: 0.88rem;
    color: var(--text-tertiary);
    font-style: italic;
    margin-bottom: 2px;
  }

  .example-card .fr {
    font-size: 0.9rem;
  }

  .warning-block {
    border: 1px solid rgba(216, 72, 62, 0.2);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    background: var(--primary-red-light);
  }

  .article-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .sidebar-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
  }

  .sidebar-card h3 {
    font-size: 0.9rem;
    margin-bottom: var(--spacing-sm);
  }

  .level-name {
    font-weight: 700;
  }

  .small {
    font-size: 0.85rem;
    color: var(--text-tertiary);
  }

  .link-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: var(--spacing-xs);
  }

  .summary-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: var(--spacing-xs);
  }

  .link-list a {
    color: var(--primary-red);
    font-size: 0.9rem;
  }

  .summary-list a {
    color: var(--primary-red);
    font-size: 0.9rem;
  }

  .link-list a:hover {
    opacity: 0.7;
  }

  .summary-list a:hover {
    opacity: 0.7;
  }

  @media (max-width: 900px) {
    .article-layout {
      grid-template-columns: 1fr;
    }
  }
</style>
