---
import type { CollectionEntry } from 'astro:content';
import HSKLevelBadge from './HSKLevelBadge.astro';

interface Props {
  entry: CollectionEntry<'nuances'>;
}

const { entry } = Astro.props;
const { data, id } = entry;
const maxWordLength = data.words.reduce((max, word) => Math.max(max, word.length), 0);
const totalWordLength = data.words.reduce((sum, word) => sum + word.length, 0);
const hasLatinWord = data.words.some((word) => /[A-Za-z]/.test(word));
---

<a href={`/nuances/${id}`} class="nuance-card">
  <div class="card-header">
    <HSKLevelBadge level={data.level} size="sm" />
    <span class="category">{data.category.replace(/-/g, ' ')}</span>
  </div>

  <div class:list={[
    'words-display',
    {
      'words-many': data.words.length >= 4,
      'words-extra': data.words.length >= 5,
      'words-dense': data.words.length >= 4 || totalWordLength >= 10 || maxWordLength >= 5,
      'words-tight': data.words.length >= 5 || totalWordLength >= 14 || maxWordLength >= 7,
      'words-ultra': data.words.length >= 6 || totalWordLength >= 20 || maxWordLength >= 10,
      'words-latin': hasLatinWord,
    }
  ]}>
    {data.words.map((word, i) => (
      <>
        <span class="word">{word}</span>
        {i < data.words.length - 1 && <span class="vs">vs</span>}
      </>
    ))}
  </div>

  <div class="pinyin-display">
    {data.pinyin.join(' / ')}
  </div>

  <p class="card-summary">{data.summary}</p>

  <div class="card-footer">
    <span class="cta">Comprendre la différence</span>
    <span class="arrow">→</span>
  </div>
</a>

<style>
  .nuance-card {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-xl);
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
  }

  .nuance-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--jade-green-light);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
  }

  .category {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: capitalize;
  }

  .words-display {
    display: flex;
    align-items: baseline;
    justify-content: center;
    flex-wrap: wrap;
    gap: clamp(0.3rem, 1vw, 0.75rem);
    row-gap: clamp(0.15rem, 0.8vw, 0.45rem);
    margin-bottom: var(--spacing-sm);
    max-width: 100%;
    overflow: visible;
  }

  .word {
    display: inline-block;
    max-width: 100%;
    font-family: var(--font-serif);
    font-size: clamp(1.8rem, 3.4vw, 2.35rem);
    line-height: 1.08;
    white-space: normal;
    overflow-wrap: anywhere;
    text-align: center;
    color: var(--text-primary);
  }

  .words-display.words-dense .word {
    font-size: clamp(1.55rem, 2.8vw, 1.95rem);
  }

  .words-display.words-tight .word {
    font-size: clamp(1.35rem, 2.3vw, 1.7rem);
  }

  .words-display.words-ultra .word {
    font-size: clamp(1.2rem, 2vw, 1.45rem);
  }

  .words-display.words-latin .word {
    font-size: clamp(1.4rem, 2.5vw, 1.8rem);
  }

  .words-display.words-latin.words-tight .word {
    font-size: clamp(1.15rem, 2.1vw, 1.4rem);
  }

  .vs {
    font-size: clamp(0.72rem, 1.2vw, 0.88rem);
    color: var(--text-tertiary);
    font-weight: 500;
    flex: 0 0 auto;
    margin: 0 2px;
  }

  .pinyin-display {
    text-align: center;
    font-style: italic;
    color: var(--jade-green);
    line-height: 1.35;
    overflow-wrap: anywhere;
    margin-bottom: var(--spacing-md);
  }

  .card-summary {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-footer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-light);
  }

  .cta {
    font-size: 0.9rem;
    color: var(--jade-green);
    font-weight: 500;
  }

  .arrow {
    color: var(--jade-green);
    opacity: 0;
    transform: translateX(-8px);
    transition: all var(--transition-base);
  }

  .nuance-card:hover .arrow {
    opacity: 1;
    transform: translateX(0);
  }
</style>
